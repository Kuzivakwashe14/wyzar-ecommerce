generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String                    @id @default(uuid())
  email            String                    @unique
  password         String
  phone            String?                   @unique
  isPhoneVerified  Boolean                   @default(false)
  isEmailVerified  Boolean                   @default(false)
  isSeller         Boolean                   @default(false)
  isVerified       Boolean                   @default(false)
  role             Role                      @default(USER)
  isSuspended      Boolean                   @default(false)
  suspensionReason String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  conversations    ConversationParticipant[]
  receivedMessages Message[]                 @relation("ReceivedMessages")
  sentMessages     Message[]                 @relation("SentMessages")
  orders           Order[]
  otps             OTP[]
  products         Product[]
  reportsReceived  Report[]                  @relation("ReportedUser")
  reportsMade      Report[]                  @relation("Reporter")
  reviews          Review[]
  sellerDetails    SellerDetails?
  verifiedSellers  SellerDetails[]           @relation("VerifiedBy")
  blockedBy        UserBlock[]               @relation("Blocked")
  blockedUsers     UserBlock[]               @relation("Blocker")

  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

model SellerDetails {
  id                    String                 @id @default(uuid())
  userId                String                 @unique
  businessName          String?
  sellerType            SellerType?
  phoneNumber           String?
  streetAddress         String?
  city                  String?
  state                 String?
  country               String?
  postalCode            String?
  verificationStatus    VerificationStatus     @default(PENDING)
  verificationNotes     String?
  verifiedAt            DateTime?
  verifiedById          String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  verifiedBy            User?                  @relation("VerifiedBy", fields: [verifiedById], references: [id])
  verificationDocuments VerificationDocument[]

  @@index([userId])
  @@index([verificationStatus])
  @@map("seller_details")
}

model VerificationDocument {
  id              String         @id @default(uuid())
  sellerDetailsId String
  documentType    DocumentType
  documentPath    String
  documentName    String?
  status          DocumentStatus @default(PENDING)
  rejectionReason String?
  uploadedAt      DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  sellerDetails   SellerDetails  @relation(fields: [sellerDetailsId], references: [id], onDelete: Cascade)

  @@index([sellerDetailsId])
  @@map("verification_documents")
}

model UserBlock {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

model Product {
  id              String         @id @default(uuid())
  sellerId        String
  name            String
  description     String
  images          String[]
  price           Float
  category        String
  quantity        Int            @default(1)
  deliveryTime    String?
  countryOfOrigin String?
  city            String?
  country         String?        @default("Zimbabwe")
  condition       Condition      @default(NEW)
  brand           String?
  tags            String[]
  ratingAverage   Float          @default(0)
  ratingCount     Int            @default(0)
  views           Int            @default(0)
  featured        Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  conversations   Conversation[]
  orderItems      OrderItem[]
  seller          User           @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  reviews         Review[]

  @@index([sellerId])
  @@index([category])
  @@index([price])
  @@index([createdAt])
  @@index([city])
  @@index([featured, createdAt])
  @@map("products")
}

model Order {
  id                String        @id @default(uuid())
  userId            String
  shippingFullName  String
  shippingAddress   String
  shippingCity      String
  shippingPhone     String
  paymentMethod     PaymentMethod @default(PAYNOW)
  paymentResultId   String?
  paymentStatus     String?
  paymentUpdateTime String?
  paymentEmail      String?
  totalPrice        Float         @default(0)
  status            OrderStatus   @default(PENDING)
  paidAt            DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  trackingNumber    String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  orderItems        OrderItem[]
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews           Review[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  name      String
  quantity  Int
  image     String
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Review {
  id               String    @id @default(uuid())
  productId        String
  userId           String
  orderId          String?
  rating           Int
  title            String?
  comment          String
  verifiedPurchase Boolean   @default(false)
  helpful          Int       @default(0)
  isApproved       Boolean   @default(true)
  isEdited         Boolean   @default(false)
  editedAt         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  order            Order?    @relation(fields: [orderId], references: [id])
  product          Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([productId, isApproved, createdAt])
  @@index([userId, createdAt])
  @@index([rating])
  @@map("reviews")
}

model Conversation {
  id            String                    @id @default(uuid())
  productId     String?
  lastMessageId String?                   @unique
  lastMessageAt DateTime                  @default(now())
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  participants  ConversationParticipant[]
  lastMessage   Message?                  @relation("LastMessage", fields: [lastMessageId], references: [id])
  product       Product?                  @relation(fields: [productId], references: [id])
  messages      Message[]
  reports       Report[]

  @@index([lastMessageAt])
  @@index([productId])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  unreadCount    Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id             String        @id @default(uuid())
  conversationId String
  senderId       String
  receiverId     String
  message        String?
  isRead         Boolean       @default(false)
  readAt         DateTime?
  attachments    String[]
  isTemplate     Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  lastMessageFor Conversation? @relation("LastMessage")
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  receiver       User          @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender         User          @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  reports        Report[]

  @@index([conversationId, createdAt])
  @@index([senderId, receiverId])
  @@index([isRead])
  @@map("messages")
}

model Report {
  id                    String        @id @default(uuid())
  reporterId            String
  reportedUserId        String
  reason                ReportReason
  description           String?
  relatedMessageId      String?
  relatedConversationId String?
  status                ReportStatus  @default(PENDING)
  adminNotes            String?
  reviewedById          String?
  reviewedAt            DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  relatedConversation   Conversation? @relation(fields: [relatedConversationId], references: [id])
  relatedMessage        Message?      @relation(fields: [relatedMessageId], references: [id])
  reportedUser          User          @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  reporter              User          @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([reporterId, reportedUserId])
  @@index([status, createdAt])
  @@map("reports")
}

model OTP {
  id        String   @id @default(uuid())
  email     String
  otp       String
  type      OTPType
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, type, createdAt])
  @@map("otps")
}

enum Role {
  USER
  SELLER
  ADMIN
}

enum SellerType {
  INDIVIDUAL
  BUSINESS
  INTERNATIONAL
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  INCOMPLETE
}

enum DocumentType {
  NATIONAL_ID
  PASSPORT
  BUSINESS_REGISTRATION
  TAX_CERTIFICATE
  PROOF_OF_ADDRESS
  BANK_STATEMENT
  OTHER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Condition {
  NEW
  USED
  REFURBISHED
}

enum PaymentMethod {
  PAYNOW
  CASH_ON_DELIVERY
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE_CONTENT
  SCAM
  FAKE_ACCOUNT
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

enum OTPType {
  REGISTRATION
  LOGIN
  PASSWORD_RESET
}
