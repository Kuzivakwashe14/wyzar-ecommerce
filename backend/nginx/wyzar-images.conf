# Nginx configuration for serving WyZar static images
# Place this file in: /etc/nginx/sites-available/ (Linux) or nginx/conf.d/ (Windows)
# Symlink to sites-enabled: ln -s /etc/nginx/sites-available/wyzar-images.conf /etc/nginx/sites-enabled/

# Upstream backend server
upstream wyzar_backend {
    server localhost:5000;
}

server {
    listen 80;
    server_name localhost wyzar.local;  # Change to your domain in production

    # Maximum upload size (must match backend)
    client_max_body_size 10M;

    # Logging
    access_log /var/log/nginx/wyzar_access.log;
    error_log /var/log/nginx/wyzar_error.log;

    # ===============================================
    # STATIC FILES - Served directly by Nginx (FAST)
    # ===============================================

    # Product Images
    location /static/uploads/ {
        alias C:/Users/tawan/Documents/WyZar/wyzar-ecommerce/backend/uploads/;  # Update this path!

        # Security: Prevent directory listing
        autoindex off;

        # Allowed file types only
        location ~ \.(jpg|jpeg|png|gif|webp|pdf)$ {
            # CORS headers (if frontend is on different domain)
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;

            # Caching headers (1 year for images)
            expires 1y;
            add_header Cache-Control "public, immutable";

            # Security headers
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;

            # Enable gzip compression
            gzip on;
            gzip_types image/jpeg image/png image/gif image/webp application/pdf;
            gzip_comp_level 6;

            # Try to serve file, return 404 if not found
            try_files $uri =404;
        }

        # Block access to all other file types
        location ~ \.* {
            deny all;
        }
    }

    # ===============================================
    # API ROUTES - Proxied to Node.js backend
    # ===============================================

    location /api/ {
        proxy_pass http://wyzar_backend;

        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable caching for API
        proxy_cache_bypass $http_upgrade;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # ===============================================
    # FRONTEND (if serving from same server)
    # ===============================================

    location / {
        proxy_pass http://localhost:3000;  # Next.js frontend

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # ===============================================
    # HEALTH CHECK
    # ===============================================

    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# ===============================================
# OPTIONAL: HTTPS Configuration
# ===============================================

# Uncomment and configure when you have SSL certificates

# server {
#     listen 443 ssl http2;
#     server_name wyzar.co.zw www.wyzar.co.zw;
#
#     # SSL Certificates
#     ssl_certificate /path/to/fullchain.pem;
#     ssl_certificate_key /path/to/privkey.pem;
#
#     # SSL Configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # ... (same location blocks as above)
# }

# Redirect HTTP to HTTPS
# server {
#     listen 80;
#     server_name wyzar.co.zw www.wyzar.co.zw;
#     return 301 https://$server_name$request_uri;
# }
